rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user belongs to the tenant
    function hasTenantId(tenantId) {
      return request.auth.token.tenant_id == tenantId;
    }

    // Helper function to check for specific roles
    function hasRole(role) {
      return request.auth.token.role == role;
    }

    function isAdmin() {
      return hasRole('ADMIN');
    }

    function isRecruiter() {
      return hasRole('RECRUITER');
    }

    function isHiringManager() {
      return hasRole('HIRING_MANAGER');
    }

    // Restrict all access by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Tenant-specific data
    match /tenants/{tenantId} {
      // Only users of this tenant can access their tenant data
      // For now, let's assume all authenticated users with the correct tenant_id can read
      allow read: if request.auth != null && hasTenantId(tenantId);
      
      // Only Admins can modify tenant settings (if stored here)
      allow write: if request.auth != null && hasTenantId(tenantId) && isAdmin();

      // Candidates sub-collection
      match /candidates/{candidateId} {
         allow read: if request.auth != null && hasTenantId(tenantId);
         // Recruiters and Admins can create/update
         allow write: if request.auth != null && hasTenantId(tenantId) && (isAdmin() || isRecruiter());
      }
      
      // Jobs sub-collection
      match /jobs/{jobId} {
        allow read: if request.auth != null && hasTenantId(tenantId);
        // Hiring Managers, Recruiters, Admins can write
        allow write: if request.auth != null && hasTenantId(tenantId) && (isAdmin() || isRecruiter() || isHiringManager());
      }
    }
  }
}
